---
title: "crops comparison"
author: "Anna Boser"
date: '2022-05-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp)
library(here)
library(stringr)
library(sf)
#library(tmap)
library(data.table)
library(tidyr)
library(dplyr)
library(ggplot2)
library(latex2exp)
library(lfe)
library(gstat)

source(here("file_paths.R"))
```

## Read in the data
```{r}
experiment_name <- "fallow_3-9_gb"
experiment_path <- here("data", "4_for_analysis", "ML_outputs",  "experiments", experiment_name)
data <- fread(file = here(experiment_path, "agriculture_yearly.csv"))
```

# clean data
```{r}
data <- filter(data, coverage_fraction>.5)

data <- data[cropnames != "",] # only keep data that has crop info (get rid of years without dwr data)
data <- data[cropnames != "Urban - residential, commercial, and industrial, unsegregated",] # remove urban
data$cropnames <- ifelse(data$cropnames %in% c("Unclassified fallow", "Idle"), "Fallow", data$cropnames) # rename unclassified fallow to just fallow

# only keep fallow pixels that are in the test set
test <- fread(test_data_loc)
list <- unique(paste(test$x, test$y, test$year))
nrow(data)
data <- data %>% filter(!(cropnames == "Fallow" & !(paste(x, y, year) %in% list)))
nrow(data)
rm(test)

data$subcropnames <- ifelse(data$subcropnames == "", data$cropnames, data$subcropnames)

data$year <- as.factor(data$year)

data <- filter(data,  subcropnames != "Greenhouse")

# combine potatoes and "potatoes or sweet potato"
data$subcropnames <- ifelse(data$subcropnames %in% c("Potatoes", "Potato or Sweet potato"), "Potato or Sweet potato", data$subcropnames)
```

```{r}
# add GSA info
# read in GSA info
gsa <- fread(gsa_table_loc)

# merge
data$x <- round(data$x, 7)
data$y <- round(data$y, 7)

gsa$cell <- NULL
gsa$coverage <- NULL
gsa$x <- round(gsa$x, 7)
gsa$y <- round(gsa$y, 7)

data <- merge(data, gsa, by = c("x", "y"), all.x=TRUE)

rm(gsa)
```


Get confidence intervals using clustered standard errors

```{r}
# plot a variogram 
sample <- data[sample(nrow(data), size = 100000, replace = FALSE),] #subset data to calculate variogram
sample$x <- (sample$x - min(sample$x))*89  # turn x into km 
sample$y <- (sample$y - min(sample$y))*111

vario_ET <- variogram(ET~1, data=sample, locations= ~x+y, cutoff= 100) 
vario_ag_ET <- variogram(ag_ET~1, data=sample, locations= ~x+y, cutoff= 100) 

vario_ET$type = "Observed ET"
vario_ag_ET$type = "Agricultural ET"

vario_ET2 <- rbind(vario_ET, vario_ag_ET)

ggplot(vario_ET2) + 
  geom_line(aes(x = dist, y = gamma, color = type)) + 
  geom_point(aes(x = dist, y = gamma, color = type)) + 
  scale_color_manual(values=c("seagreen", "navyblue")) + 
  theme_classic() + 
  theme(legend.position = c(.2, .85), 
        legend.title=element_blank()) + 
  xlab("Distance (km)") + 
  ylab("Gamma")
  
```


```{r}
# create clusters based on location and year. Function creates clusters of size dist km. 
assign_cluster <- function(x, y, dist){
  
  x_size = dist/89 # 1 degree lon (x) = 89km = 89000m
  y_size = dist/111 # 1 degree lat (y) = 111km = 111000m
  
  x_fold = floor(x/x_size)*x_size
  y_fold = floor(y/y_size)*y_size
  
  cv_fold = paste(x_fold, y_fold, sep = ",")
  
  return(cv_fold)
}

data$cluster <- mapply(assign_cluster, data$x, data$y, 75)
```

```{r}
#percent of total ET that is ag water consumption
total_ET <- mean(filter(data, cropnames != "Fallow")$ET)
ag_ET_mean <- felm(ag_ET~1 | 0 | 0 | cluster+year, filter(data, cropnames != "Fallow"))

scalar = 1.2 # turns mm/month to cm/year
paste("avg ag ET:")
upper <- (ag_ET_mean$coefficients[1] + 2*ag_ET_mean$cse)*scalar
mean <- (ag_ET_mean$coefficients[1])*scalar
lower <- (ag_ET_mean$coefficients[1] - 2*ag_ET_mean$cse)*scalar
paste(upper, mean, lower)

paste("percent ag ET:")
upper <- (ag_ET_mean$coefficients[1] + 2*ag_ET_mean$cse)/total_ET
mean <- (ag_ET_mean$coefficients[1])/total_ET
lower <- (ag_ET_mean$coefficients[1] - 2*ag_ET_mean$cse)/total_ET
paste(upper, mean, lower)

# check if the variation of fallow ET acorss space is significant
summary(felm(ET_pred~x*y | 0 | 0 | cluster+year, filter(data, cropnames != "Fallow")))
```


```{r}
# function to extract the mean and ci values from felm regression
df_from_felm <- function(input_lm, name_length = 10, var="cropnames"){
  ET_df <- as.data.frame(cbind(input_lm$coefficients, input_lm$cse))
  colnames(ET_df) <- c("ET", "se")
  ET_df$min <- ET_df$ET-(1.96*ET_df$se)
  ET_df$max <- ET_df$ET+(1.96*ET_df$se)
  ET_df[,var] <- substring(rownames(ET_df), name_length)
  return(ET_df)
}
```

##################
# compare crops
```{r}
# get confidence intervals using clustered standard errors
ET_c <- felm(ET~cropnames-1 | 0 | 0 | cluster+year, data) # -1 means no intercept
ET_c %>% summary()
ET_df <- df_from_felm(ET_c)
rm(ET_c)

ag_ET_c <- felm(ag_ET~cropnames-1 | 0 | 0 | cluster+year, data)
ag_ET_c %>% summary()
ag_ET_df <- df_from_felm(ag_ET_c)
rm(ag_ET_c)

ET_pred_c <- felm(ET_pred~cropnames-1 | 0 | 0 | cluster+year, data)
ET_pred_c %>% summary()
ET_pred_df <- df_from_felm(ET_pred_c)
rm(ET_pred_c)

ET_df$type = "ET"
ag_ET_df$type = "ag_ET"
ET_pred_df$type = "ET_pred"

bardata <- rbind(ET_df, ET_pred_df, ag_ET_df)
bardata$type <- as.factor(bardata$type)
bardata$type <- relevel(bardata$type, 'ET_pred')
```

### Plot
```{r}

scalar = 1.2 # turns mm/month to cm/year

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  geom_col(data = filter(bardata, type != "ET"), aes(y = ET*scalar, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated natural ET")) + 
  geom_col(data = filter(bardata, type == "ET"), aes(y = ET*scalar, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())

fwrite(bardata, here(experiment_path, "bardata.csv"))
```

California’s irrigated pasturelands—including valley, foothill, and mountain meadow pastures— account for nearly 500,000 acres across the state, and ranks third among agricultural water users. https://rangelands.ucdavis.edu/ipep/

```{r}
print(bardata %>% filter(type == "ag_ET") %>% mutate(ET = ET*1.2, min = min*1.2, max = max*1.2)) # scalar to cm/year
```
```{r}

scalar = 1.2 # turns mm/month to cm/year

ggplot(filter(bardata, type == "ag_ET", cropnames != "Young Perennial"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET", cropnames != "Young Perennial"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  geom_boxplot(data=filter(data, cropnames != "Young Perennial"), aes(y=ag_ET*scalar), outlier.size = .5, outlier.alpha = .002, color = "grey60") + 
  geom_col(data = filter(bardata, type != "ET", cropnames != "Young Perennial"), aes(y = ET*scalar, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated fallow ET")) + 
  geom_col(data = filter(bardata, type == "ET", cropnames != "Young Perennial"), aes(y = ET*scalar, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET", cropnames != "Young Perennial"), aes(ymax = min*scalar, ymin = max*scalar), color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET", cropnames != "Young Perennial"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  ylim(c(-35, 165)) + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())

fwrite(bardata, here(experiment_path, "bardata.csv"))
```


# boxplot to show spread in how much a given crop consumes
```{r}
ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  geom_boxplot(data=data, aes(y=ag_ET*scalar), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET*scalar), fill = "seagreen", alpha = 0.6) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Agricultural ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```

```{r}
# control for GSAs
crop_gsa <- data %>% group_by(cropnames, GSA_Name) %>% summarize(ag_ET_expected_gsa = mean(ag_ET))
crop_overall <- data %>% group_by(cropnames) %>% summarize(ag_ET_expected = mean(ag_ET))
crop_gsa <- merge(crop_gsa, crop_overall, by = "cropnames", all.x = TRUE)
crop_gsa$crop_correction <- crop_gsa$ag_ET_expected_gsa - crop_gsa$ag_ET_expected
crop_gsa <- crop_gsa %>% select(cropnames, GSA_Name, crop_correction)
data <- merge(data, crop_gsa, by = c("cropnames", "GSA_Name"))
data$ag_ET_corrected <- data$ag_ET - data$crop_correction

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  geom_boxplot(data=data, aes(y=ag_ET_corrected*scalar), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET*scalar), fill = "seagreen", alpha = 0.6) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Agricultural ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```


```{r}
# is the large spread in ag ET because of young perennials

# get the 2018 young perennials
yp2018 <- filter(data, year == 2018 & cropnames == "Young Perennial")

# get the 2018 young perennials in 2019
yp18_2019 <- filter(data, year == 2019 & paste(x, y) %in% paste(yp2018$x, yp2018$y))

# filter to only keep the ones that are no longer young in 2019
yp18_2019_nyp <- filter(yp18_2019, cropnames %in% c("Citrus and subtropical", "Deciduous fruits and nuts", "Vineyards")) # almost all turn intothis

# the other c("Citrus and subtropical", "Deciduous fruits and nuts", "Vineyards") in 2019
nyp_2019 <- filter(data, year == 2019 & !(paste(x, y) %in% paste(yp2018$x, yp2018$y)) & cropnames %in% c("Citrus and subtropical", "Deciduous fruits and nuts", "Vineyards"))

paste(mean(yp2018$ag_ET), mean(yp18_2019_nyp$ag_ET), mean(nyp_2019$ag_ET))
```


```{r}
# are ET_pred_c different from each other? 
felm(ET_pred~cropnames | year | 0 | cluster, data) %>% summary
# how much of the variation is explained by crop type? 
felm(ag_ET~cropnames | year | 0 | cluster, data) %>% summary
# what about when you control for ET_pred, PET, and general location (NAME)
felm(ag_ET~cropnames+PET+ET_pred+NAME | year | 0 | cluster, data) %>% summary
```

Fallow ET_pred is significantly lower and Rice is significantly higher. 

# compare subcrops
```{r}
# get rid of classes I'm not that interested in 
data <- filter(data,  !(subcropnames %in% c("Miscellaneous deciduous", "Miscellaneous field", "Miscellaneous grain and hay", "Greenhouse", "Miscellaneous grasses", "Miscellaneous subtropical fruit", "Miscellaneous truck")))
```


```{r}
# get confidence intervals using clustered standard errors
ET_c <- felm(ET~subcropnames-1 | 0 | 0 | cluster+year, data) # -1 means no intercept
# ET_c %>% summary()
ET_df <- df_from_felm(ET_c, 13, "subcropnames")
rm(ET_c)

ag_ET_c <- felm(ag_ET~subcropnames-1 | 0 | 0 | cluster+year, data)
# ag_ET_c %>% summary()
ag_ET_df <- df_from_felm(ag_ET_c, 13, "subcropnames")
rm(ag_ET_c)

ET_pred_c <- felm(ET_pred~subcropnames-1 | 0 | 0 | cluster+year, data)
# ET_pred_c %>% summary()
ET_pred_df <- df_from_felm(ET_pred_c, 13, "subcropnames")
rm(ET_pred_c)

ET_df$type = "ET"
ag_ET_df$type = "ag_ET"
ET_pred_df$type = "ET_pred"

bardata <- rbind(ET_df, ET_pred_df, ag_ET_df)
bardata$type <- as.factor(bardata$type)
bardata$type <- relevel(bardata$type, 'ET_pred')
```

```{r}
print(bardata %>% filter(type == "ag_ET") %>% mutate(ET = ET*1.2, min = min*1.2, max = max*1.2)) # scalar to cm/year
```

### Plot
```{r}

scalar = 1.2 # turns mm/month to cm/year

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  geom_col(data = filter(bardata, type != "ET"), aes(y = ET*scalar, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated natural ET")) + 
  geom_col(data = filter(bardata, type == "ET"), aes(y = ET*scalar, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())

fwrite(bardata, here(experiment_path, "bardata.csv"))
```

California’s irrigated pasturelands—including valley, foothill, and mountain meadow pastures— account for nearly 500,000 acres across the state, and ranks third among agricultural water users. https://rangelands.ucdavis.edu/ipep/

# boxplot to show spread in how much a given crop consumes
```{r}
ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  geom_boxplot(data=data, aes(y=ag_ET*scalar), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET*scalar), fill = "seagreen", alpha = 0.6) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Agricultural ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```

```{r}
ggplot(filter(bardata, type == "ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "navyblue") +
  geom_boxplot(data=data, aes(y=ET*scalar), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET*scalar), fill = "navyblue", alpha = 0.6) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "navyblue") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Observed ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```

```{r}
# control for GSAs
crop_gsa <- data %>% group_by(subcropnames, GSA_Name) %>% summarize(ag_ET_expected_gsa = mean(ag_ET))
crop_overall <- data %>% group_by(subcropnames) %>% summarize(ag_ET_expected = mean(ag_ET))
crop_gsa <- merge(crop_gsa, crop_overall, by = "subcropnames", all.x = TRUE)
crop_gsa$subcrop_correction <- crop_gsa$ag_ET_expected_gsa - crop_gsa$ag_ET_expected
crop_gsa <- crop_gsa %>%select(subcropnames, GSA_Name, subcrop_correction)
data <- merge(data, crop_gsa, by = c("subcropnames", "GSA_Name"))
data$ag_ET_corrected <- data$ag_ET - data$subcrop_correction

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  geom_boxplot(data=data, aes(y=ag_ET_corrected*scalar), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET*scalar), fill = "seagreen", alpha = 0.6) + 
  geom_linerange(aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Agricultural ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```


```{r}
# are ET_pred_c different from each other? 
felm(ET_pred~subcropnames | year | 0 | cluster, data) %>% summary
# how much of the variation is explained by crop type? 
felm(ag_ET~subcropnames | year | 0 | cluster, data) %>% summary
# what about when you control for ET_pred, PET, and general location (NAME)
felm(ag_ET~subcropnames+PET+ET_pred+NAME | year | 0 | cluster, data) %>% summary

felm(ag_ET~subcropnames*PET*ET_pred | year | 0 | cluster, data) %>% summary
felm(ag_ET~subcropnames+PET+ET_pred | year | 0 | cluster, data) %>% summary
felm(ag_ET~subcropnames*PET | year | 0 | cluster, data) %>% summary
felm(ag_ET~subcropnames*ET_pred | year | 0 | cluster, data) %>% summary
felm(ag_ET~subcropnames+PET | year | 0 | cluster, data) %>% summary
felm(ag_ET~subcropnames+ET_pred | year | 0 | cluster, data) %>% summary
```

```{r}
felm(ET~subcropnames | year | 0 | cluster, data) %>% summary
felm(ET~subcropnames*ET_pred | year | 0 | cluster, data) %>% summary
```


# If everyone growing a crop that consumes above the median switched to growing the median, how much water would we save? 
# If no one switched crops, but everyone who had ET above the median grew at the median, how much water would we save? 
```{r}
# get the mean and the median for each crop
crop_medians <- data %>% group_by(subcropnames) %>% summarize(crop_median = median(ag_ET))

# merge to the larger dataset
data <- merge(data, crop_medians, by = "subcropnames") %>% filter(cropnames != "Fallow") 

# pick the median crop. This is the median crop grown arranged by median ag ET
median_crop <- crop_medians[crop_medians$crop_median == median(data$crop_median),]

# calcualte stats
data$grow_median_crop <- ifelse(data$crop_median > median_crop$crop_median, median_crop$crop_median, data$ag_ET) 
data$grow_at_crop_median <- ifelse(data$ag_ET > data$crop_median, data$crop_median, data$ag_ET) 
 
paste("control (cm/year) = ", mean(data$ag_ET)*scalar)
paste("growing median crop (cm/year) = ", mean(data$grow_median_crop)*scalar, ". Savings (cm/year): ", (mean(data$ag_ET) - mean(data$grow_median_crop))*scalar)
paste("growing at crop median (cm/year) = ", mean(data$grow_at_crop_median)*scalar, ". Savings (cm/year): ", (mean(data$ag_ET) - mean(data$grow_at_crop_median))*scalar)
```

```{r}
# same thing but also by county

# get the mean and the median for each crop
crop_medians_county <- data %>% group_by(subcropnames, NAME) %>% summarize(crop_median_county = median(ag_ET))

# merge to the larger dataset
data <- merge(data, crop_medians_county, by = c("subcropnames", "NAME")) %>% filter(cropnames != "Fallow") 

# pick the median crop. This is the median crop grown arranged by median ag ET
county_median_crop <- data %>% group_by(NAME) %>% summarize(county_median_crop_median = median(crop_median_county))
data <- merge(data, county_median_crop, by = "NAME")

# calcualte stats
data$grow_median_crop <- ifelse(data$crop_median > data$county_median_crop_median, data$county_median_crop_median, data$ag_ET) 
data$grow_at_crop_median <- ifelse(data$ag_ET > data$crop_median_county, data$crop_median_county, data$ag_ET) 
 
paste("control (cm/year) = ", mean(data$ag_ET)*scalar)
paste("growing median crop (cm/year) = ", mean(data$grow_median_crop)*scalar, ". Savings (cm/year): ", (mean(data$ag_ET) - mean(data$grow_median_crop))*scalar)
paste("growing at crop median (cm/year) = ", mean(data$grow_at_crop_median)*scalar, ". Savings (cm/year): ", (mean(data$ag_ET) - mean(data$grow_at_crop_median))*scalar)
```



# are farmers that use a lot of water repeat offenders? As in they are consistently above the 75th percentile for all three years? 
```{r}
# keep high consumers
high <- data %>% filter(cropnames !="Fallow") %>% group_by(year, subcropnames) %>% summarize(ag_ET_threshold = quantile(ag_ET, c(.75), na.rm=TRUE))
# an offender is someone above their threshold
with_thresh <- merge(data, high, by = c("year", "subcropnames"))
offender <- filter(with_thresh, subcropnames != "", ag_ET>ag_ET_threshold)
offender$exists = 1
# A repeat offender is someone above their threshold all three years
repeat_offender <- offender %>% select(x,y,year, exists) %>% pivot_wider(names_from=year, values_from = exists, values_fill=0)
repeat_offender <- filter(repeat_offender, `2016`+`2018`+`2019` == 3)

# because you need to have a crop type for all three years, not everyone can be a repeat offender. 
# how many possible repeat offenders are there? 
possible_offender <- filter(with_thresh, subcropnames != "")
possible_offender$exists = 1
# A repeat offender is someone above their threshold all three years
possible_repeat_offender <- possible_offender %>% select(x,y,year, exists) %>% pivot_wider(names_from=year, values_from = exists, values_fill=0)
possible_repeat_offender <- filter(possible_repeat_offender, `2016`+`2018`+`2019` == 3)

nrow(repeat_offender)/nrow(possible_repeat_offender)

# 21% of cropland is above the 75th percentile for their year/subcropname for all three years. So we have a lot of repeat offenders!
```

# how does drought affect ET ag? As in how different is each year? 
```{r}
data$year_f <- as.factor(data$year)
year_lm <- felm(ag_ET~year_f-1 | 0 | 0 | cluster, filter(data, cropnames != "Fallow"))
summary(year_lm)

year_df <- df_from_felm(year_lm, 7, "year")

ggplot(year_df) + 
  geom_col(aes(x = year, y = ET), fill = "blue", alpha = .6) + 
  geom_linerange(aes(x = year, ymin = min, ymax = max), color = "blue") +
  theme_classic() + 
  labs(fill='') + 
  xlab("Year") + 
  ylab("Agricultural ET (mm/month)") + 
  theme(axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```

# what about when controlling for changes in crop type? 
```{r}
data$cropres <- lm(ag_ET~subcropnames-1, data)$residuals
year_lm <- felm(cropres~year_f-1 | 0 | 0 | cluster, filter(data, cropnames != "Fallow"))
summary(year_lm)

year_df <- df_from_felm(year_lm, 7, "year")

ggplot(year_df) + 
  geom_col(aes(x = year, y = ET), fill = "blue", alpha = .6) + 
  geom_linerange(aes(x = year, ymin = min, ymax = max), color = "blue") +
  theme_classic() + 
  labs(fill='') + 
  xlab("Year") + 
  ylab("Agricultural ET (mm/month)") + 
  theme(axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```

# if all farmers that consume above average for their subcrop type, ET_pred, PET, and NAME on any given year only consumed average, how much water would we save? 
```{r}
# full_lm <- felm(ag_ET~subcropnames+PET+ET_pred+NAME | year | 0 | cluster, data)
```

# if all farmers switched to an average water consumption crop, how much would we save? 
```{r}

```




