---
title: "Visualize experiments"
author: "Anna Boser"
date: "2022-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(data.table)
library(dplyr)
library(stringr)
library(ggplot2)
library(sf)
library(latex2exp)
library(lfe)

source(here("file_paths.R"))
```

```{r}
experiment_name <- "fveg_no_wetlands_2-12_gb"
experiment_path <- here("data", "4_for_analysis", "ML_outputs",  "experiments", experiment_name)
dataset <- "fveg"
training <- TRUE
```

# ET over fallow lands vs predictions
```{r}
# read in the fallow fields predictions
fallow <- fread(here(experiment_path, "fallow.csv"))
fallow[fallow == -9999] <- NA # this is the na value

# split the fallow data into val and test
set.seed(0) # always get the same "random" split
if (training){
  full <- fallow
  locs <- unique(paste(fallow$x, fallow$y, sep = ","))
  locs <- locs[sample(1:length(locs), length(locs)/10)] # keep a tenth of the locations
  fallow <- filter(fallow, paste(fallow$x, fallow$y, sep = ",") %in% locs)
}
```

# in order to get CIs, I need clustered errors
```{r}
assign_cluster <- function(x, y, dist){
  
  x_size = dist/89 # 1 degree lon (x) = 89km = 89000m
  y_size = dist/111 # 1 degree lat (y) = 111km = 111000m
  
  x_fold = floor(x/x_size)*x_size
  y_fold = floor(y/y_size)*y_size
  
  cv_fold = paste(x_fold, y_fold, sep = ",")
  
  return(cv_fold)
}

fallow$cluster <- mapply(assign_cluster, fallow$x, fallow$y, 75*6)
```


# Get confidence intervals using clustered standard errors for: 
1. county
2. year
3. month
```{r}
fallow$year_f <- as.factor(fallow$year)
fallow$month_f <- as.factor(fallow$month)
# get confidence intervals using clustered standard errors
county <- felm(ag_ET~NAME-1 | 0 | 0 | cluster+year_f+month_f, fallow) # -1 mean no intercept
year <- felm(ag_ET~year_f-1 | 0 | 0 | cluster+month_f, fallow)
month <- felm(ag_ET~month_f-1 | 0 | 0 | cluster+year_f, fallow)
overall <- felm(ag_ET~1 | 0 | 0 | cluster, fallow)

# demeaned
fallow$ag_ET_dem = fallow$ag_ET + overall$coefficients[1]
county_dem <- felm(ag_ET_dem~NAME-1 | 0 | 0 | cluster+year_f+month_f, fallow) 
year_dem <- felm(ag_ET_dem~year_f-1 | 0 | 0 | cluster+month_f, fallow)
month_dem <- felm(ag_ET_dem~month_f-1 | 0 | 0 | cluster+year_f, fallow)
```

```{r}
# extract the mean and ci values from each
ts_from_felm <- function(input_lm){
  ET_df <- as.data.frame(cbind(input_lm$coefficients, input_lm$cse))
  colnames(ET_df) <- c("ET", "se")
  ET_df$min <- ET_df$ET-(1.96*ET_df$se)
  ET_df$max <- ET_df$ET+(1.96*ET_df$se)
  ET_df$month <- as.numeric(substring(rownames(ET_df), 8))
  return(ET_df)
}

ET_df <- ts_from_felm(felm(ET~month_f-1 | 0 | 0 | cluster+year, fallow))
ET_df$type = "Observed ET"
ET_pred_df <- ts_from_felm(felm(ET_pred~month_f-1 | 0 | 0 | cluster+year, fallow))
ET_pred_df$type = "Simulated natural ET"
ts <- rbind(ET_df, ET_pred_df)

scalar = 1 # 1.2 turns mm/month to cm/year

ggplot(ts, aes(x = month)) + 
  geom_line(aes(y = ET*scalar, col = type)) + 
  geom_ribbon(aes(ymax = min*scalar, ymin = max*scalar, fill = type), alpha = .2)

ts_bias <- ts_from_felm(felm(ag_ET~month_f-1 | 0 | 0 | cluster+year, fallow))
ggplot(ts_bias, aes(x = month)) + 
  geom_line(aes(y = ET*scalar)) + 
  geom_ribbon(aes(ymax = min*scalar, ymin = max*scalar), alpha = .2)
```

# plot in space
```{r}
study_area <- st_read(study_area_loc) %>% st_transform(st_crs("+proj=longlat +datum=WGS84"))
counties <- st_read(counties_loc) %>% filter(STATEFP == "06") %>% st_transform(st_crs("+proj=longlat +datum=WGS84"))

loc_df <- fallow %>% group_by(x,y) %>% summarise(ag_ET = mean(ag_ET), 
                                       ET = mean(ET), 
                                       ET_pred = mean(ET_pred)) 
loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ag_ET), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow ag ET")

loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ET), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow observed ET")

loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ET_pred), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow pred ET")
```


```{r}
# how to clean fallow data
# I want to remove outliers that are actually ag -- so focus on growing season

loc_df <- fallow %>% filter(month %in% c(7,8,9)) %>%
  group_by(x,y,year) %>% summarise(ag_ET = mean(ag_ET), 
                                       ET = mean(ET), 
                                       ET_pred = mean(ET_pred)) 

loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ET), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow observed ET")
  
  loc_df <- fallow %>% filter(month %in% c(3,4)) %>%
  group_by(x,y,year) %>% summarise(ag_ET = mean(ag_ET), 
                                       ET = mean(ET), 
                                       ET_pred = mean(ET_pred)) 
  
  loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ET), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow observed ET")
  
df8 <- fallow %>% filter(month == 8) %>% select(x, y, year, august = ET)
loc_df <- fallow %>% filter(!(month %in% c(6,7,8,9)))%>% group_by(x,y,year) %>% summarise(ET = mean(ET)) 
loc_df <- merge(loc_df, df8, by = c("x", "y", "year"))
loc_df$prop8 <- loc_df$august/loc_df$ET
  
  loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=prop8), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow observed ET")
```

################################################################################
# filtered fallow here
```{r}
# filter out the 95% highest in the growing season
gs <- filter(fallow, month %in% c(7,8,9)) %>%
  group_by(x,y,year) %>% summarise(ET = mean(ET)) 
cutoff <- quantile(gs$ET, probs = seq(0,1,.95))[2]
low_gs <- gs[gs$ET < cutoff,]


filtered_fallow <- fallow %>% filter(paste(fallow$x, fallow$y, fallow$year) %in% paste(low_gs$x, low_gs$y, low_gs$year))

loc_df <- filtered_fallow %>% 
  group_by(x,y,year) %>% summarise(ag_ET = mean(ag_ET), 
                                       ET = mean(ET), 
                                       ET_pred = mean(ET_pred)) 

low_gs %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ET), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow observed ET")

loc_df %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  geom_point(aes(x=x,y=y,col=ET), size = .1) + 
  scale_color_distiller(palette="RdBu") + 
  theme_void() + 
  ggtitle("fallow observed ET")
```


### A scatterplot with months averaged out
```{r}
# averaging over different months
fallow_year <- fallow %>% group_by(x, y) %>% summarize(ET = mean(ET, na.rm=TRUE), 
                                                       ET_pred = mean(ET_pred, na.rm=TRUE))

r2 <- summary(lm(ET~ET_pred, data=fallow_year))$r.squared 
Bias <- mean(fallow_year$ET_pred - fallow_year$ET, na.rm=TRUE)
ggplot(fallow_year) +
  geom_jitter(aes(x=ET_pred, y=ET), alpha=0.2, size =.1) + 
  theme_classic() + 
  geom_abline(intercept=0,slope=1, color="red") + 
  # annotate("text", x=3, y=1.5, label= paste("R2:", round(r2, 3), "Bias:", round(Bias, 3))) + 
  xlab("Predicted natural ET (mm/month)") + 
  ylab("Observed fallow ET (mm/month)") +
    xlim(c(0,4*30)) + 
    ylim(c(0,4*30))

print(paste("R2:", round(r2, 3), "Bias:", round(Bias, 3)))
```

### A time series 
```{r}

# plot out the time series
fallow_ts <- fallow %>% group_by(month) %>% summarize(ET = mean(ET, na.rm=TRUE), 
                                                       ET_pred = mean(ET_pred, na.rm=TRUE))

ggplot(fallow_ts) + 
  geom_line(aes(x=month, y=ET), color="red") + 
  geom_line(aes(x=month, y=ET_pred), color="black") 

```

Here I just got curious about what ag ET vs fallow ET look like. Seems like fallow ET is probably artificially high. 
```{r}
# ag <- fread(here("data", "3_for_counterfactual", "agriculture", "agriculture.csv"))
# ag$month <- str_extract(ag$month, '(?<=_)\\d+') %>% as.numeric()
# 
# # plot out the time series
# ag_ts <- ag %>% group_by(month) %>% summarize(ET = mean(ET, na.rm=TRUE))
# 
# ggplot(ag_ts) + 
#   geom_line(aes(x=month, y=ET), color="red") + 
#   geom_line(data=fallow_ts, aes(x=month, y=ET), color="black")
```


# Spatial CV

```{r}
# read in the spatial_CV predictions
cv <- fread(here(experiment_path, "crossval_predictions_test.csv"))
cv[cv == -9999] <- NA # this is the na value

if (months_ts){
  # get a nice column of numeric months
  months <- select(cv, names(cv)[grepl("month", names(cv))])
  cv$month <- names(months)[max.col(months)] 
  cv$month <- str_extract(cv$month, '(?<=_)\\d+') %>% as.numeric()
}

cv$mean_dist <- cv$fold_size/6 # the average distance between a held out point and the border to the hold out
```

## map out the performance of the model as hold out sizes increase

```{r}
if (months_ts){
  gridded_cv_metrics <- cv %>% 
    group_by(x, y, cv_fold, fold_size) %>%
    summarize(ET = mean(ET, na.rm = TRUE), 
              ET_pred = mean(ET_pred, na.rm = TRUE)) %>%
    group_by(cv_fold, fold_size) %>%
    summarize(r2 = 1 - mean((ET_pred - ET)^2)/mean((ET - mean(ET))^2), 
              Bias = mean(ET_pred - ET, na.rm = TRUE), 
              RMSE = sqrt(mean(ET_pred - ET, na.rm = TRUE)^2), 
              mae = mean(abs((ET_pred - ET)), na.rm = TRUE),
              ET = mean(ET, na.rm = TRUE), 
              ET_pred = mean(ET_pred, na.rm = TRUE))
} else {
  gridded_cv_metrics <- cv %>%
    group_by(cv_fold, fold_size) %>%
    summarize(r2 = 1 - mean((ET_pred - ET)^2)/mean((ET - mean(ET))^2),
              Bias = mean(ET_pred - ET, na.rm = TRUE),
              RMSE = sqrt(mean(ET_pred - ET, na.rm = TRUE)^2),
              mae = mean(abs((ET_pred - ET)), na.rm = TRUE),
              ET = mean(ET, na.rm = TRUE),
              ET_pred = mean(ET_pred, na.rm = TRUE))
}
```

Turn the cv fold back into something meaningful
```{r}
# first turn "fold" into x and y coordinates
gridded_cv_metrics$x <- as.numeric(str_extract(gridded_cv_metrics$cv_fold, "[-.0-9]*(?=,)")) + gridded_cv_metrics$fold_size/200000
gridded_cv_metrics$y <- as.numeric(str_extract(gridded_cv_metrics$cv_fold, "(?<=,)[-.0-9]*")) + gridded_cv_metrics$fold_size/200000
```


```{r}
# study area and counties for plotting
study_area <- st_read(study_area_loc) %>% st_transform(st_crs("+proj=longlat +datum=WGS84"))
counties <- st_read(counties_loc) %>% filter(STATEFP == "06") %>% st_transform(st_crs("+proj=longlat +datum=WGS84"))

gridded_cv_metrics$RMSE <- ifelse(gridded_cv_metrics$RMSE>1.5, 1.5, gridded_cv_metrics$RMSE)
gridded_cv_metrics$Bias <- ifelse(gridded_cv_metrics$Bias>1, 1, gridded_cv_metrics$Bias)
gridded_cv_metrics$Bias <- ifelse(gridded_cv_metrics$Bias<(-1), -1, gridded_cv_metrics$Bias)

filter(gridded_cv_metrics) %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_raster(aes(x=x, y=y, fill=Bias)) +
  facet_wrap(vars(fold_size/1000)) +
  scale_fill_distiller(palette="Spectral", direction = -1, limits = c(-1*30,1*30)) +
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  theme_classic() +
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

filter(gridded_cv_metrics) %>%
  ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_raster(aes(x=x, y=y, fill=RMSE)) +
  facet_wrap(vars(fold_size/1000)) +
  scale_fill_distiller(palette="Spectral", direction = -1, limits = c(0,1.5*30)) +
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  theme_classic() +
  xlim(c(-122.92, -118)) + 
  ylim(c(34.7, 40.754)) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

## Plot out the performance of the model as hold out sizes get bigger relative to the distance between ag and natural training data

First get the distribution of distances between ag and natural data (specifically the test data)
```{r}
dist_filename <- here(distance_distribution_path, paste0(dataset, ".csv"))

if (file.exists(dist_filename)){
  library(parallel)
  library(tictoc)
  
  dist <- fread(dist_filename)
} else {
  stop('No distance file for this dataset. Make one using 3_analysis/1_additional_data_manipulation/2_ag_natural_distance.R')
}
```



```{r}
if (months_ts){
  cv_metrics <- cv %>% 
    group_by(x, y, fold_size, mean_dist) %>%
    summarize(ET = mean(ET, na.rm = TRUE), 
              ET_pred = mean(ET_pred, na.rm = TRUE)) %>%
    group_by(fold_size, mean_dist) %>%
    summarize(r2 = 1 - mean((ET_pred - ET)^2)/mean((ET - mean(ET))^2), 
              Bias = mean(ET_pred - ET, na.rm = TRUE), 
              RMSE = sqrt(mean(ET_pred - ET, na.rm = TRUE)^2), 
              mae = mean(abs((ET_pred - ET)), na.rm = TRUE),
              ET = mean(ET, na.rm = TRUE), 
              ET_pred = mean(ET_pred, na.rm = TRUE))
} else {
  cv_metrics <- cv %>%
    group_by(fold_size, mean_dist) %>%
    summarize(r2 = 1 - mean((ET_pred - ET)^2)/mean((ET - mean(ET))^2),
              Bias = mean(ET_pred - ET, na.rm = TRUE),
              RMSE = sqrt(mean(ET_pred - ET, na.rm = TRUE)^2),
              mae = mean(abs((ET_pred - ET)), na.rm = TRUE),
              ET = mean(ET, na.rm = TRUE),
              ET_pred = mean(ET_pred, na.rm = TRUE))
}
```


```{r}
coef = 2/5

ggplot(NULL) + 
  stat_density(data = dist, aes(x=mindist/1000), fill = "grey10", alpha = .3) + 
  geom_line(data = cv_metrics, aes(x=mean_dist/1000, y = r2*coef), color = "red") +
  geom_point(data = cv_metrics, aes(x=mean_dist/1000, y = r2*coef), color = "red") +
  xlab(TeX("Distance of agricultural pixel to nearest natural pixel (km) \n Average distance of point to border of hold-out (km)")) + 
  theme_bw() + 
  theme(axis.title.x = element_text(vjust=-2.5)) +
  xlim(c(0, max(cv_metrics$mean_dist/1000))) + 
  scale_y_continuous(
    name = "Distribution of agricultural pixels",
    sec.axis = sec_axis(~./coef, name=TeX("Model performance ($R^{2}$)")))
```

### Plot the performance for the different months too
```{r}
if (months_ts){
  cv_metrics <- cv %>% 
    group_by(fold_size, month, mean_dist) %>%
    summarize(r2 = 1 - mean((ET_pred - ET)^2)/mean((ET - mean(ET))^2), 
              Bias = mean(ET_pred - ET, na.rm = TRUE), 
              RMSE = sqrt(mean(ET_pred - ET, na.rm = TRUE)^2), 
              mae = mean(abs((ET_pred - ET)), na.rm = TRUE),
              ET = mean(ET, na.rm = TRUE), 
              ET_pred = mean(ET_pred, na.rm = TRUE))
  
  coef = 2/5
  
  ggplot(NULL) + 
    stat_density(data = dist, aes(x=mindist/1000), fill = "grey10", alpha = .3) + 
    geom_line(data = cv_metrics, aes(x=mean_dist/1000, y = r2*coef, color = as.factor(month))) +
    geom_point(data = cv_metrics, aes(x=mean_dist/1000, y = r2*coef, color = as.factor(month))) +
    xlab(TeX("Distance of agricultural pixel to nearest natural pixel (km) \n Average distance of point to border of hold-out (km)")) + 
    theme_bw() + 
    theme(axis.title.x = element_text(vjust=-2.5)) +
    xlim(c(0, max(cv_metrics$mean_dist/1000))) + 
    scale_y_continuous(
      name = "Distribution of agricultural pixels",
      sec.axis = sec_axis(~./coef, name=TeX("Model performance ($R^{2}$)")))
}
```

## Some scatterplots and time series

Make these using the CV with the fold size that is closest to the double of the mean distance between ag and natural (a bit conservative but only slightly)
```{r}
mean_dist <- mean(dist$mindist)
folds <- unique(cv$mean_dist)
best_fold <- folds[abs(folds-(mean_dist)) == min(abs(folds-(mean_dist)))]
cv_best_fold <- filter(cv, mean_dist == best_fold)
print(cv_best_fold$fold_size %>% unique())
```

### A scatterplot with colors by month
```{r}
if (months_ts){
  # with different months
  r2 <- summary(lm(ET~ET_pred, data=cv_best_fold))$r.squared 
  Bias <- mean(cv_best_fold$ET_pred - cv_best_fold$ET, na.rm=TRUE)
  ggplot(cv_best_fold) +
    geom_jitter(aes(x=ET_pred, y=ET, color=as.factor(month)), alpha=0.2, size =.1) + 
    theme_classic() + 
    geom_abline(intercept=0,slope=1, color="red") + 
    # annotate("text", x=4.5, y=1.5, label= paste("R2:", round(r2, 3), "Bias:", round(Bias, 3))) + 
    xlab("Predicted natural ET (mm/month)") + 
    ylab("Observed fallow ET (mm/month)") +
    xlim(c(0,8*30)) + 
    ylim(c(0,8*30))
}

print(paste("R2:", round(r2, 3), "Bias:", round(Bias, 3)))
```

### A scatterplot with months averaged out
```{r}
if (months_ts){
  # averaging over different months
  cv_best_fold_year <- cv_best_fold %>% group_by(x, y) %>% summarize(ET = mean(ET, na.rm=TRUE), 
                                                         ET_pred = mean(ET_pred, na.rm=TRUE))
} else {
  cv_best_fold_year <- cv_best_fold
}

r2 <- summary(lm(ET~ET_pred, data=cv_best_fold_year))$r.squared 
Bias <- mean(cv_best_fold_year$ET_pred - cv_best_fold_year$ET, na.rm=TRUE)
ggplot(cv_best_fold_year) +
  geom_jitter(aes(x=ET_pred, y=ET), alpha=0.02, size =.01) + 
  theme_classic() + 
  geom_abline(intercept=0,slope=1, color="red") + 
  # annotate("text", x=4.5, y=1.5, label= paste("R2:", round(r2, 3), "Bias:", round(Bias, 3))) + 
  xlab("Predicted natural ET (mm/month)") + 
  ylab("Observed fallow ET (mm/month)") +
    xlim(c(0,6*30)) + 
    ylim(c(0,6*30))

print(paste("R2:", round(r2, 3), "Bias:", round(Bias, 3)))
```

### A time series 
```{r}
if (months_ts){
  # plot out the time series
  cv_best_fold_ts <- cv_best_fold %>% group_by(month) %>% summarize(ET = mean(ET, na.rm=TRUE), 
                                                         ET_pred = mean(ET_pred, na.rm=TRUE))
  
  ggplot(cv_best_fold_ts) + 
    geom_line(aes(x=month, y=ET), color="red") + 
    geom_line(aes(x=month, y=ET_pred), color="black") + 
    geom_line(data = fallow_ts, aes(x=month, y=ET), color="blue") + 
    geom_line(data = fallow_ts, aes(x=month, y=ET_pred), color="green") 
}
```
