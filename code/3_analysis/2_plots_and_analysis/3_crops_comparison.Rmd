---
title: "crops comparison"
author: "Anna Boser"
date: '2022-05-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp)
library(here)
library(stringr)
library(sf)
#library(tmap)
library(data.table)
library(tidyr)
library(dplyr)
library(ggplot2)
library(latex2exp)
library(lfe)

source(here("file_paths.R"))
source(here("helper_functions.R"))
```

## Read in the data
```{r}
experiment_name <- "fallow_3-9_gb"
experiment_path <- here("data", "4_for_analysis", "ML_outputs",  "experiments", experiment_name)
data <- fread(file = here(experiment_path, "agriculture_yearly.csv"))
```

# clean data
```{r}
data <- filter(data, coverage_fraction>.5)

data <- data[cropnames != "",] # only keep data that has crop info (get rid of years without dwr data)
data <- data[cropnames != "Urban - residential, commercial, and industrial, unsegregated",] # remove urban
data$cropnames <- ifelse(data$cropnames %in% c("Unclassified fallow", "Idle"), "Fallow", data$cropnames) # rename unclassified fallow to just fallow

# only keep fallow pixels that are in the test set
test <- fread(test_data_loc)
list <- unique(paste(test$x, test$y, test$year))
nrow(data)
data <- data %>% filter(!(cropnames == "Fallow" & !(paste(x, y, year) %in% list)))
nrow(data)
rm(test)

data$subcropnames <- ifelse(data$subcropnames == "", data$cropnames, data$subcropnames)

data <- filter(data,  subcropnames != "Greenhouse")

# combine potatoes and "potatoes or sweet potato"
data$subcropnames <- ifelse(data$subcropnames %in% c("Potatoes", "Potato or Sweet potato"), "Potato or Sweet potato", data$subcropnames)
```

```{r}
# create clusters based on location and year. Function creates clusters of size dist km. 
data$cluster <- mapply(assign_cluster, data$x, data$y, 75)

# scale to cm/year instead of mm/month
scalar = 1.2 # turns mm/month to cm/year
data <- scale(data, scalar)

# control for variation across years
data <- year_control(data)
```


## Numbers
```{r}
#percent of total ET that is ag water consumption
total_ET <- mean(filter(data, cropnames != "Fallow")$ET)
ag_ET_mean <- felm(ag_ET~1 | 0 | 0 | cluster+year, filter(data, cropnames != "Fallow"))

print_CI("avg ag ET:", ag_ET_mean$coefficients[1], ag_ET_mean$cse)
print_CI("percent ag ET:", ag_ET_mean$coefficients[1]/total_ET, ag_ET_mean$cse/total_ET)

# check if the variation of fallow ET across space is significant
summary(felm(ET_pred~x*y | 0 | 0 | cluster+year, filter(data, cropnames == "Fallow")))

# variation within crop types
sds <- data %>% group_by(cropnames) %>% summarize(sd = sd(ag_ET))
print(sds, n = nrow(sds))
paste("active sds average:", mean(filter(sds, cropnames != "Fallow")$sd))
```

##################
# compare crops
```{r}
# get confidence intervals using clustered standard errors
ET_c <- felm(ET~cropnames-1 | 0 | 0 | cluster+year, data) # -1 means no intercept
# ET_c %>% summary()
ET_df <- df_from_felm(ET_c)
rm(ET_c)

ag_ET_c <- felm(ag_ET~cropnames-1 | 0 | 0 | cluster+year, data)
# ag_ET_c %>% summary()
ag_ET_df <- df_from_felm(ag_ET_c)
rm(ag_ET_c)

ET_pred_c <- felm(ET_pred~cropnames-1 | 0 | 0 | cluster+year, data)
# ET_pred_c %>% summary()
ET_pred_df <- df_from_felm(ET_pred_c)
rm(ET_pred_c)

ET_df$type = "ET"
ag_ET_df$type = "ag_ET"
ET_pred_df$type = "ET_pred"

bardata <- rbind(ET_df, ET_pred_df, ag_ET_df)
bardata$type <- as.factor(bardata$type)
bardata$type <- relevel(bardata$type, 'ET_pred')

# sd across crop types
print("sd across crop types:")
sd(filter(bardata, type == "ag_ET")$ET)
```

### Plot

California’s irrigated pasturelands—including valley, foothill, and mountain meadow pastures— account for nearly 500,000 acres across the state, and ranks third among agricultural water users. https://rangelands.ucdavis.edu/ipep/

```{r}
print(bardata %>% filter(type == "ag_ET"))
print_CI("Deciduous fruits and nuts", mean = filter(bardata, type == "ag_ET")$ET[2], se = filter(bardata, type == "ag_ET")$se[2])
print_CI("Grain and hay crops", mean = filter(bardata, type == "ag_ET")$ET[5], se = filter(bardata, type == "ag_ET")$se[5])
```
```{r}
ggplot(filter(bardata, type == "ag_ET", cropnames != "Young Perennial"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET", cropnames != "Young Perennial"), aes(ymax = min, ymin = max), color = "seagreen") + 
  geom_boxplot(data=filter(data, cropnames != "Young Perennial"), aes(y=ag_ET), outlier.size = .3, outlier.alpha = .005, color = "grey30") + 
  geom_col(data = filter(bardata, type != "ET", cropnames != "Young Perennial"), aes(y = ET, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated fallow ET")) + 
  geom_col(data = filter(bardata, type == "ET", cropnames != "Young Perennial"), aes(y = ET, color = type), size=.5, alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET", cropnames != "Young Perennial"), aes(ymax = min, ymin = max), size=1.1, color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET", cropnames != "Young Perennial"), aes(ymax = min, ymin = max), size=1.1, color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  ylim(c(-35, 165)) + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())

fwrite(bardata, here(experiment_path, "bardata.csv"))
```


# scrap plots
```{r, eval = FALSE}
# The original bardata without boxplot

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) +
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min, ymin = max), color = "seagreen") +
  geom_col(data = filter(bardata, type != "ET"), aes(y = ET, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated natural ET")) +
  geom_col(data = filter(bardata, type == "ET"), aes(y = ET, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) +
  geom_linerange(data = filter(bardata, type == "ET"), aes(ymax = min, ymin = max), color = "navyblue") +
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min, ymin = max), color = "seagreen") +
  ylab("cm/year") +
  theme_classic() +
  labs(fill='') +
  theme(axis.text.x = element_text(angle = 30, hjust=1),
        axis.title.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "top",
        legend.direction="horizontal",
        legend.title=element_blank())

# boxplot to show spread in how much a given crop consumes

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "seagreen") +
  geom_boxplot(data=data, aes(y=ag_ET), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET), fill = "seagreen", alpha = 0.6) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "seagreen") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Agricultural ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```

```{r}
# are ET_pred_c different from each other? 
felm(ET_pred~cropnames | year | 0 | cluster, data) %>% summary
# how much of the variation is explained by crop type? 
felm(ag_ET~cropnames | year | 0 | cluster, data) %>% summary
# what about when you control for climate
felm(ag_ET~cropnames+PET+Elevation+Aspect+Slope+TWI+Soil | year | 0 | cluster, data) %>% summary
```

Fallow ET_pred is significantly lower and Rice is significantly higher. 

# compare subcrops
```{r}
# get rid of classes I'm not that interested in 
data <- filter(data,  !(subcropnames %in% c("Miscellaneous deciduous", "Miscellaneous field", "Miscellaneous grain and hay", "Greenhouse", "Miscellaneous grasses", "Miscellaneous subtropical fruit", "Miscellaneous truck")))

# variation within crop types
sds <- data %>% group_by(subcropnames) %>% summarize(sd = sd(ag_ET))
print(sds, n = nrow(sds))
paste("active sds average:", mean(filter(sds, subcropnames != "Fallow")$sd))
```


```{r}
# get confidence intervals using clustered standard errors
ET_c <- felm(ET~subcropnames-1 | 0 | 0 | cluster+year, data) # -1 means no intercept
# ET_c %>% summary()
ET_df <- df_from_felm(ET_c, 13, "subcropnames")
rm(ET_c)

ag_ET_c <- felm(ag_ET~subcropnames-1 | 0 | 0 | cluster+year, data)
# ag_ET_c %>% summary()
ag_ET_df <- df_from_felm(ag_ET_c, 13, "subcropnames")
rm(ag_ET_c)

ET_pred_c <- felm(ET_pred~subcropnames-1 | 0 | 0 | cluster+year, data)
# ET_pred_c %>% summary()
ET_pred_df <- df_from_felm(ET_pred_c, 13, "subcropnames")
rm(ET_pred_c)

ET_df$type = "ET"
ag_ET_df$type = "ag_ET"
ET_pred_df$type = "ET_pred"

bardata <- rbind(ET_df, ET_pred_df, ag_ET_df)
bardata$type <- as.factor(bardata$type)
bardata$type <- relevel(bardata$type, 'ET_pred')

# sd across crop types
print("sd across crop types:")
sd(filter(bardata, type == "ag_ET")$ET)
```

```{r}
print(bardata %>% filter(type == "ag_ET"))
print_CI("Almonds", mean = filter(bardata, type == "ag_ET")$ET[2], se = filter(bardata, type == "ag_ET")$se[2])
```

### Plot

California’s irrigated pasturelands—including valley, foothill, and mountain meadow pastures— account for nearly 500,000 acres across the state, and ranks third among agricultural water users. https://rangelands.ucdavis.edu/ipep/

```{r}
ggplot(filter(bardata, type == "ag_ET", subcropnames != "Young Perennial"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET", subcropnames != "Young Perennial"), aes(ymax = min, ymin = max), color = "seagreen") + 
  geom_boxplot(data=filter(data, subcropnames != "Young Perennial"), aes(y=ag_ET), outlier.size = .3, outlier.alpha = .005, color = "grey30") + 
  geom_col(data = filter(bardata, type != "ET", subcropnames != "Young Perennial"), aes(y = ET, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated fallow ET")) + 
  geom_col(data = filter(bardata, type == "ET", subcropnames != "Young Perennial"), aes(y = ET, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET", subcropnames != "Young Perennial"), aes(ymax = min, ymin = max), size = 1, color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET", subcropnames != "Young Perennial"), aes(ymax = min, ymin = max), size = 1, color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  ylim(c(-45, 175)) + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())
```

# scrap plots
```{r, eval = FALSE}
ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min, ymin = max), color = "seagreen") + 
  geom_col(data = filter(bardata, type != "ET"), aes(y = ET, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated natural ET")) + 
  geom_col(data = filter(bardata, type == "ET"), aes(y = ET, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET"), aes(ymax = min, ymin = max), color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min, ymin = max), color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())


# boxplot to show spread in how much a given crop consumes

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "seagreen") +
  geom_boxplot(data=data, aes(y=ag_ET), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET), fill = "seagreen", alpha = 0.6) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "seagreen") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Agricultural ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 

# observed ET 
ggplot(filter(bardata, type == "ET"), aes(x = reorder(subcropnames, ET))) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "navyblue") +
  geom_boxplot(data=data, aes(y=ET), outlier.size = .5, outlier.alpha = .002) + 
  geom_col(aes(y = ET), fill = "navyblue", alpha = 0.6) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "navyblue") +
  theme_classic() + 
  labs(fill='') + 
  ylab("Observed ET (cm/year)") + 
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.5), 
        axis.title.x=element_blank(), 
        # axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```


```{r}
# are ET_pred_c different from each other? 
felm(ET_pred~subcropnames | year | 0 | cluster, data) %>% summary
# how much of the variation is explained by crop type? 
felm(ag_ET~subcropnames | year | 0 | cluster, data) %>% summary
# what about when you control for climate
felm(ag_ET~subcropnames+PET+Elevation+Aspect+Slope+TWI+Soil | year | 0 | cluster, data) %>% summary

# what percent of within-crop variation do we account for with climate? 
mean_by_crop <- data %>% group_by(subcropnames) %>% summarize(crop_mean = mean(ag_ET))
data <- merge(data, mean_by_crop, by = c("subcropnames"))
data$within_crop_var <- data$ag_ET - data$crop_mean

felm(within_crop_var~PET+Elevation+Aspect+Slope+TWI+Soil | year | 0 | cluster, data) %>% summary
```


