---
title: "crops comparison"
author: "Anna Boser"
date: '2022-05-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sp)
library(here)
library(stringr)
library(sf)
#library(tmap)
library(data.table)
library(tidyr)
library(dplyr)
library(ggplot2)
library(latex2exp)
library(lfe)
library(gstat)

source(here("file_paths.R"))
```

```{r}
avg_irr <- 1.97*30 # irrigation efficiency in mm/month spread over the year (mm/month)
```

## Read in the data
```{r}
experiment_name <- "fveg_no_wetlands_2-12_gb"
experiment_path <- here("data", "4_for_analysis", "ML_outputs",  "experiments", experiment_name)
months_ts <- TRUE
```

```{r}
data <- fread(file = here(experiment_path, "agriculture_tidy.csv"))
```

# add crop type information 
```{r}
data <- data[cropnames != "",] # only keep data that has crop info (get rid of years without dwr data)
data <- data[cropnames != "Urban - residential, commercial, and industrial, unsegregated",] # remove urban
data$cropnames <- ifelse(data$cropnames %in% c("Unclassified fallow", "Idle"), "Fallow", data$cropnames) # rename unclassified fallow to just fallow
```

## average over months but not year
```{r}
if (months_ts == TRUE){
  # Average over monthgroups
  data <- data %>% group_by(x, y, year, cropnames) %>% summarize(ET = mean(ET, na.rm=TRUE), 
                                                  ET_pred = mean(ET_pred, na.rm=TRUE), 
                                                  ag_ET = ET-ET_pred, 
                                                  PET = mean(PET, na.rm=TRUE))
}
```

Get confidence intervals using clustered standard errors

```{r}
# plot a variogram 
# spdf <- SpatialPointsDataFrame(coords = select(data, x, y), data = select(data, -x, -y))
sample <- data[sample(nrow(data), size = 100000, replace = FALSE),] #subset data to calculate variogram
sample$x <- (sample$x - min(sample$x))*89  # turn x into km 
sample$y <- (sample$y - min(sample$y))*111

vario_ET <- variogram(ET~1, data=sample, locations= ~x+y, cutoff= 100) 
vario_ag_ET <- variogram(ag_ET~1, data=sample, locations= ~x+y, cutoff= 100) 

vario_ET$type = "Observed ET"
vario_ag_ET$type = "Agricultural ET"

vario_ET2 <- rbind(vario_ET, vario_ag_ET)
```

```{r}
ggplot(vario_ET2) + 
  geom_line(aes(x = dist, y = gamma, color = type)) + 
  geom_point(aes(x = dist, y = gamma, color = type)) + 
  scale_color_manual(values=c("seagreen", "navyblue")) + 
  theme_classic() + 
  theme(legend.position = c(.2, .85), 
        legend.title=element_blank()) + 
  xlab("Distance (km)") + 
  ylab("Gamma")
  
```


```{r}
# create clusters based on location and year. Function creates clusters of size dist km. 
assign_cluster <- function(x, y, year, dist){
  
  x_size = dist/89 # 1 degree lon (x) = 89km = 89000m
  y_size = dist/111 # 1 degree lat (y) = 111km = 111000m
  
  x_fold = floor(x/x_size)*x_size
  y_fold = floor(y/y_size)*y_size
  
  cv_fold = paste(x_fold, y_fold, year, sep = ",")
  
  return(cv_fold)
}

data$cluster <- mapply(assign_cluster, data$x, data$y, data$year, 50)
```


```{r}
# get confidence intervals using clustered standard errors
ET_c <- felm(ET~cropnames-1 | 0 | 0 | cluster, data) # -1 mean no intercept
ag_ET_c <- felm(ag_ET~cropnames-1 | 0 | 0 | cluster, data)
ET_pred_c <- felm(ET_pred~cropnames-1 | 0 | 0 | cluster, data)
```

```{r}
# extract the mean and ci values from each
df_from_felm <- function(input_lm){
  ET_df <- as.data.frame(cbind(input_lm$coefficients, input_lm$cse))
  colnames(ET_df) <- c("ET", "se")
  ET_df$min <- ET_df$ET-(2*ET_df$se)
  ET_df$max <- ET_df$ET+(2*ET_df$se)
  ET_df$cropnames <- substring(rownames(ET_df), 10)
  return(ET_df)
}

ET_df <- df_from_felm(ET_c)
ag_ET_df <- df_from_felm(ag_ET_c)
ET_pred_df <- df_from_felm(ET_pred_c)
```

### Calculate some statistics 

```{r}
felm(ET~cropnames | 0 | 0 | cluster, data) %>% summary()
felm(ag_ET~cropnames | 0 | 0 | cluster, data) %>% summary()
felm(ET_pred~cropnames | 0 | 0 | cluster, data) %>% summary()
```

```{r}
#percent of total ET that is ag water consumption
total_ET <- mean(filter(data, cropnames != "Fallow or idle")$ET)
ag_ET_mean <- felm(ag_ET~1 | 0 | 0 | cluster, filter(data, cropnames != "Fallow or idle"))
upper <- (ag_ET_mean$coefficients[1] + 2*ag_ET_mean$cse)/total_ET
mean <- (ag_ET_mean$coefficients[1])/total_ET
lower <- (ag_ET_mean$coefficients[1] - 2*ag_ET_mean$cse)/total_ET
paste(upper, mean, lower)
```


### Plot
```{r}
ET_df$type = "ET"
ag_ET_df$type = "ag_ET"
ET_pred_df$type = "ET_pred"

bardata <- rbind(ET_df, ET_pred_df, ag_ET_df)
bardata$type <- as.factor(bardata$type)
bardata$type <- relevel(bardata$type, 'ET_pred')

scalar = 1.2 # turns mm/month to cm/year

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  geom_col(data = filter(bardata, type != "ET"), aes(y = ET*scalar, fill = type), alpha = .6) +
  scale_fill_manual(values=c(ag_ET="seagreen", ET_pred="goldenrod4"), breaks=c("ag_ET","ET_pred"), labels = c("Agricultural ET", "Simulated natural ET")) + 
  geom_col(data = filter(bardata, type == "ET"), aes(y = ET*scalar, color = type), alpha = 0) +
  scale_color_manual(values=c("navyblue"), labels = c("Observed ET")) + 
  geom_linerange(data = filter(bardata, type == "ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "navyblue") + 
  geom_linerange(data = filter(bardata, type == "ag_ET"), aes(ymax = min*scalar, ymin = max*scalar), color = "seagreen") + 
  ylab("cm/year") + 
  theme_classic() + 
  labs(fill='') + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank())

fwrite(bardata, here(experiment_path, "bardata.csv"))
```

California’s irrigated pasturelands—including valley, foothill, and mountain meadow pastures— account for nearly 500,000 acres across the state, and ranks third among agricultural water users. https://rangelands.ucdavis.edu/ipep/

Sd vs water use scatterplot


sd barplot
```{r}

ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
  geom_col(aes(y = ET, fill = "Agricultural ET"), alpha = 0.6) + 
  scale_fill_manual(values=c("seagreen"), labels = c("Agricultural ET")) + 
  geom_linerange(aes(ymax = min, ymin = max), color = "seagreen") + 
  theme_classic() + 
  labs(fill='') + 
  ylab("mm/month") + 
  theme(axis.text.x = element_text(angle = 30, hjust=1), 
        axis.title.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        legend.position = "top", 
        legend.direction="horizontal", 
        legend.title=element_blank()) 
```
```{r}
# to run this, need standard deviation. 

# ggplot(filter(bardata, type == "ag_ET"), aes(x = reorder(cropnames, ET))) + 
#   geom_col(aes(y = ET, fill = "Agricultural ET"), alpha = 0.6) + 
#   scale_fill_manual(values=c("seagreen"), labels = c("Agricultural ET")) + 
#   geom_linerange(aes(ymax = min, ymin = max), color = "seagreen") + 
#   geom_point(aes(y = sd, color = "Standard deviation")) + 
#   scale_color_manual(values=c("black"), labels = c("Standard deviation")) + 
#   theme_classic() + 
#   labs(fill='') + 
#   ylab("mm/month") + 
#   theme(axis.text.x = element_text(angle = 30, hjust=1), 
#         axis.title.x=element_blank(), 
#         axis.ticks.x=element_blank(), 
#         legend.position = "top", 
#         legend.direction="horizontal", 
#         legend.title=element_blank()) 
```

regressions to see how much is explained by crops and crops+climate
```{r}
felm(ag_ET~cropnames | 0 | 0 | cluster, data) %>% summary()
felm(ag_ET~cropnames+PET | 0 | 0 | cluster, data) %>% summary()
felm(ag_ET~cropnames+ET_pred | 0 | 0 | cluster, data) %>% summary()
```
