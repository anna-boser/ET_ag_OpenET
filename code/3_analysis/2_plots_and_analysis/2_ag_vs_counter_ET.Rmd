---
title: "Analysis"
author: "Anna Boser"
date: '2022-05-02'
output: html_document
---

```{r}
library(here)
library(tidyr)
library(dplyr)
library(ggplot2)
library(rgdal)
library(maptools)
library(data.table)
library(sf)
library(stringr)

source(here("file_paths.R"))
```


# First glance at ET in agriculture 

## Read in the data
```{r}
experiment_name <- "fallow_3-9_gb"
experiment_path <- here("data", "4_for_analysis", "ML_outputs",  "experiments", experiment_name)
```

```{r}
data <- fread(file = here(experiment_path, "agriculture_yearly.csv"))
data[data == -9999] <- NA # this is the na value
```

```{r}
data <- data[cropnames != "Urban - residential, commercial, and industrial, unsegregated",] # remove urban
data$cropnames <- ifelse(data$cropnames %in% c("Unclassified fallow", "Idle"), "Fallow", data$cropnames) # rename unclassified

# only keep fallow pixels that are in the test set
test <- fread(test_data_loc)
list <- unique(paste(test$x, test$y, test$year))
nrow(data)
data <- data %>% filter(!(cropnames == "Fallow" & !(paste(x, y, year) %in% list)))
nrow(data)
rm(test)
```


## histograms 
```{r}
fallow <- filter(data, cropnames == "Fallow")
hist_data <- filter(data, cropnames != "Fallow")

hist_data <- pivot_longer(hist_data, cols=c(ET, ET_pred, ag_ET), names_to="type", values_to="ET")
hist_data$type <- factor(hist_data$type, levels=c("ET", "ET_pred", "ag_ET"))

# if the the pixel is fallow, make "ET" called "fallow" instead
fallow <- fallow %>% select(x, y, year, ET)
fallow$type <- "fallow"
hist_data <- hist_data %>% select(x, y, year, ET, type)

hist_data <- rbind(hist_data, fallow)

hist_data_full<- hist_data
hist_data <- hist_data_full[sample(1:nrow(hist_data_full), 20000, rep=FALSE),]

ggplot(hist_data) + 
  geom_density(aes(x=ET, fill = type), lwd = 0, alpha = .4) + 
  scale_fill_manual(name="", labels=c("Observed ET (on agricultural lands)", "Simulated fallow ET (on agricultural lands)", "Agricultural ET (on agricultural lands)", "Fallow ET (on fallow lands)"), values=c("navyblue", "darkgoldenrod4", "seagreen", "grey")) +
  theme_classic() +  
  theme(legend.position = c(0.75, 0.8),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  xlab("ET (mm/month)")
```


## Make maps of ET, ET_pred, and ag_ET

```{r}
# Average over years
data <- data %>% group_by(x, y) %>% summarize(ET = mean(ET, na.rm=TRUE), 
                                                ET_pred = mean(ET_pred, na.rm=TRUE), 
                                                ag_ET = ET-ET_pred)
```

```{r}
data <- pivot_longer(data, cols=c(ET, ET_pred, ag_ET), names_to="type", values_to="ET")
data$type <- factor(data$type, levels=c("ET", "ET_pred", "ag_ET"))
```

```{r}
# study area and counties for plotting
study_area <- st_read(study_area_loc) %>% st_transform(st_crs("+proj=longlat +datum=WGS84"))
counties <- st_read(counties_loc) %>% filter(STATEFP == "06") %>% st_transform(st_crs("+proj=longlat +datum=WGS84"))
```

```{r}
scalar = 1.2 # mm/month to cm/year
# full_data <- data
# data <- full_data[sample(nrow(full_data), size = 100000, replace = FALSE),] # subset for fast testing

new.labs <- c("Observed ET", "Simulated fallow ET", "Agricultural ET")
names(new.labs) <- c("ET", "ET_pred", "ag_ET")

ggplot() + 
  geom_sf(data = counties, color=alpha("white",1), size = .2) + 
  geom_raster(data = data, aes(x=x, y=y, fill=ET*scalar)) +
  facet_grid(cols=vars(type), labeller = labeller(type = new.labs)) +
  scale_fill_gradientn(name="ET (cm/year)", colours = c("darkgoldenrod2", "khaki1", "lightgreen",  "deepskyblue","mediumblue", "navyblue", "midnightblue", "black"), limits = c(-39.1, 234.6)) +
  geom_sf(data = study_area, fill=alpha("red",0), color = "black", size = .2) + 
  xlim(c(-122.92, -118.6)) + 
  ylim(c(34.94, 40.754)) + 
  theme_classic() +
  theme(legend.position = c(0.92, 0.79),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

